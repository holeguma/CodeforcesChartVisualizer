<!DOCTYPE html>
<html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
         <meta charset="utf-8">
         <title>D3 Test</title>
         <script type="text/javascript" src="./lib/d3.js"></script>
      </head>
      <body>
<style>

</style>
<script type="text/javascript">
//このファイルと同じディレクトリに「lib/d3.js」と「contest_data」(これはGoogle Driveで共有します)を置いてください
var cnt=0;
let n_contests=1260;

//自分のrating,問題のdifficulty,解けたかどうか, から新しいratingを計算する
function updateRating(rating,difficulty,result,K=32){
    //if(rating-difficulty>400&&result==0)return rating;
    var winProbability=1.0/(Math.pow(10.0,(difficulty-rating)/400.0)+1.0);
    var newRating=rating+K*(result-winProbability);
    return newRating;
}
//ユーザーネーム→各タグのrating のハッシュを用意する
var hash={};
//デフォルトのハッシュ
var Status={
    userID:"sample",
    "bitmasks":1500,
    "divide and conquer":1500,
    "math":1500,
    "data structures":1500,
    "trees":1500,
    "dp":1500,
    "greedy":1500,
    "binary search":1500,
    "sortings":1500,
    "number theory":1500,
    "fft":1500,
    "brute force":1500,
    "hashing":1500,
    "meet-in-the-middle":1500,
    "two pointers":1500,
    "implementation":1500,
    "strings":1500,
    "constructive algorithms":1500,
    "graphs":1500,
    "combinatorics":1500,
    "dfs and similar":1500,
    "dsu":1500,
    "probabilities":1500,
    "geometry":1500,
    "interactive":1500,
    "ternary search":1500,
    "shortest paths":1500,
    "flows":1500,
    "matrices":1500,
    "2-sat":1500,
    "graph matchings":1500,
    "games":1500,
    "*special":1500,
    "string suffix structures":1500,
    "expression parsing":1500,
    "chinese remainder theorem":1500,
    "schedules":1500
}

//コンテストIDから、参加者全員のratingを更新する
function calcRating(contestID){
    return new Promise((resolve,reject)=>{
        var filename="./contest_data/"+contestID+".json";
        d3.json(filename).then(function(data){
            //コンテストデータがなければスキップ
            if(data.status=="FAILED"){
                console.log(contestID+":FAILED");
                return resolve();
            }
            let problems=data.result.problems;
            let n_problems=problems.length;

            let ranks=data.result.rows;
            let n_contestants=ranks.length;
            for(let i=0;i<n_contestants;i++){
                let name=ranks[i].party.members[0].handle;

                //もしハッシュに名前が登録されてなければ新しく作る
                if(!hash[name]){
                    hash[name]=Object.create(Status);
                    hash[name].userID=name;
                }
                for(let j=0;j<n_problems;j++){
                    let result=ranks[i].problemResults[j].points?1:0;
                    let difficulty=problems[j].rating;
                    if(!difficulty)continue;//問題にdifficultyが設定されてなければスキップ
                    for(let tag of problems[j].tags){
                        let rating=hash[name][tag];
                        hash[name][tag]=updateRating(rating,difficulty,result);
                    }
                }
                resolve();
            }
        })
    })
}

async function calc_all(){
    for(let i=1000;i<=n_contests;i++){
        var result = await calcRating(i);
    }
}

calc_all().then(function(){
    console.log(hash["Mojumbo"]);
    console.log(hash["holeguma"]);
    console.log(hash["tourist"]);
    console.log(hash["rng_58"]);
    console.log(hash["ransewhale"]);
    console.log(hash["QWE_QWE"]);
    console.log(hash["totori0908"]);
    console.log(hash["Rubikun"]);
})

</script>
</body></html>
