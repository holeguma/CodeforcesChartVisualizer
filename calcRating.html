<!DOCTYPE html>
<html lang="en">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
    <link href="https://fonts.googleapis.com/css?family=Open+Sans:400,300" rel='stylesheet' type='text/css'>
    <link href='https://fonts.googleapis.com/css?family=Raleway' rel='stylesheet' type='text/css'>
    <title>D3 Test</title>
    <script src="https://d3js.org/d3.v5.min.js" charset="utf-8"></script>
    <script src="https://d3js.org/d3-path.v1.min.js" charset="utf-8"></script>
    <script src="./bower_components/radar-chart-d3/src/radar-chart.js" charset="utf-8"></script>
</head>

<body>
    <style>
        body {
            font-family: 'Open Sans', sans-serif;
            font-size: 11px;
            font-weight: 300;
            fill: #242424;
            text-align: center;
            text-shadow: 0 1px 0 #fff, 1px 0 0 #fff, -1px 0 0 #fff, 0 -1px 0 #fff;
            cursor: default;
        }

        .legend {
            font-family: 'Raleway', sans-serif;
            fill: #333333;
        }
    </style>
    <form id="form1" action="#">
        <input type="text" id="You" value=""><br>
        <input type="text" id="Rivals" value=""><br>
        <input type="button" onclick="button_clicked()" value="Enter">
    </form>
    <br><br><br>
    <div class="radarChart" style="display: inline-flex;"></div>
    <script type="text/javascript">
        //このファイルと同じディレクトリに「lib/d3.js」と「contest_data」(これはGoogle Driveで共有します)を置いてください



        var cnt = 0;
        let n_contests = 1260;

        //自分のrating,問題のdifficulty,解けたかどうか, から新しいratingを計算する
        function updateRating(rating, difficulty, result, K = 64) {
            //if(rating-difficulty>400&&result==0)return rating;
            var winProbability = 1.0 / (Math.pow(10.0, (difficulty - rating) / 400.0) + 1.0);
            var newRating = rating + K * (result - winProbability);
            return newRating;
        }
        //ユーザーネーム→各タグのrating のハッシュを用意する
        var hash = {};
        //デフォルトのハッシュ
        const Status = {
            userID: "sample",
            "bitmasks": { value: 1500, solveCount: 0 },
            "divide and conquer": { value: 1500, solveCount: 0 },
            "math": { value: 1500, solveCount: 0 },
            "data structures": { value: 1500, solveCount: 0 },
            "trees": { value: 1500, solveCount: 0 },
            "dp": { value: 1500, solveCount: 0 },
            "greedy": { value: 1500, solveCount: 0 },
            "binary search": { value: 1500, solveCount: 0 },
            "sortings": { value: 1500, solveCount: 0 },
            "number theory": { value: 1500, solveCount: 0 },
            "fft": { value: 1500, solveCount: 0 },
            "brute force": { value: 1500, solveCount: 0 },
            "hashing": { value: 1500, solveCount: 0 },
            "meet-in-the-middle": { value: 1500, solveCount: 0 },
            "two pointers": { value: 1500, solveCount: 0 },
            "implementation": { value: 1500, solveCount: 0 },
            "strings": { value: 1500, solveCount: 0 },
            "constructive algorithms": { value: 1500, solveCount: 0 },
            "graphs": { value: 1500, solveCount: 0 },
            "combinatorics": { value: 1500, solveCount: 0 },
            "dfs and similar": { value: 1500, solveCount: 0 },
            "dsu": { value: 1500, solveCount: 0 },
            "probabilities": { value: 1500, solveCount: 0 },
            "geometry": { value: 1500, solveCount: 0 },
            "interactive": { value: 1500, solveCount: 0 },
            "ternary search": { value: 1500, solveCount: 0 },
            "shortest paths": { value: 1500, solveCount: 0 },
            "flows": { value: 1500, solveCount: 0 },
            "matrices": { value: 1500, solveCount: 0 },
            "2-sat": { value: 1500, solveCount: 0 },
            "graph matchings": { value: 1500, solveCount: 0 },
            "games": { value: 1500, solveCount: 0 },
            "*special": { value: 1500, solveCount: 0 },
            "string suffix structures": { value: 1500, solveCount: 0 },
            "expression parsing": { value: 1500, solveCount: 0 },
            "chinese remainder theorem": { value: 1500, solveCount: 0 },
            "schedules": { value: 1500, solveCount: 0 }
        };

        var DEBUG = false;
        var showID = "tourist";
        //コンテストIDから、参加者全員のratingを更新する
        function calcRating(contestID) {
            return new Promise((resolve, reject) => {
                var filename = "./contest_data/" + contestID + ".json";
                d3.json(filename).then(function (data) {
                    //console.log(data);
                    //コンテストデータがなければスキップ
                    if (data.status == "FAILED") {
                        console.log(contestID + ":FAILED");
                        return resolve();
                    }
                    else {
                        console.log(contestID + ":OK");
                    }
                    let problems = data.result.problems;
                    let n_problems = problems.length;

                    let ranks = data.result.rows;
                    let n_contestants = ranks.length;
                    if (!n_contestants) return resolve();
                    for (let i = 0; i < n_contestants; i++) {
                        let name = ranks[i].party.members[0].handle;
                        if (ranks[i].party.participantType != 'CONTESTANT') continue;// Contestantでなければスキップ
                        //もしハッシュに名前が登録されてなければ新しく作る
                        if (!hash[name]) {
                            hash[name] = JSON.parse(JSON.stringify(Status));
                            hash[name].userID = name;
                        }
                        if (DEBUG && name == showID) {
                            console.log(data.result.problems);
                            console.log(ranks[i].problemResults);
                            console.log(hash[name]);
                        }
                        for (let j = 0; j < n_problems; j++) {
                            let result = ranks[i].problemResults[j].points ? 1 : 0;
                            let difficulty = problems[j].rating;
                            if (!difficulty) continue;//問題にdifficultyが設定されてなければスキップ
                            for (let tag of problems[j].tags) {
                                if (tag == name) continue;
                                let rating = hash[name][tag].value;
                                var K = 64;
                                //そのタグの問題を解いた回数が少なければレート変化を大きくする
                                if (hash[name][tag].solveCount < 5) K *= (5 - hash[name][tag].solveCount);
                                hash[name][tag].value = updateRating(rating, difficulty, result, K);
                                if (DEBUG && name == showID) {
                                    console.log(tag + ":" + rating + "->" + hash[name][tag].value);
                                }
                                if (result) hash[name][tag].solveCount++;
                            }
                        }
                    }
                    resolve();
                })
            })
        }

        async function calc_all() {
            for (let i = 1100; i <= n_contests; i++) {
                var result = await calcRating(i);
            }
        }

        calc_all().then(function () {
            console.log(hash["Mojumbo"]);
            console.log(hash["holeguma"]);
            console.log(hash["tourist"]);
            console.log(hash["rng_58"]);
            console.log(hash["ransewhale"]);
            console.log(hash["QWE_QWE"]);
            console.log(hash["totori0908"]);
            console.log(hash["Rubikun"]);
        })

        function showBarGraph() {
            var svg = d3.select("body")
                .append("svg")
                .attr("width", 1200)
                .attr("height", 1000);
            svg.selectAll("rect")
                .data(data[0].axes)
                .enter()
                .append("rect")
                .attr("x", function (d, i) {
                    return i * (20 + 1);
                })
                .attr("y", function (d, i) {
                    return 500 - d.value / 10;
                })
                .attr("width", 20)
                .attr("height", function (d) {
                    return d.value / 10;
                });
            console.log("done");
        }
        function button_clicked() {
            data = [];
            var you = document.getElementById("You").value;
            var rivals = (document.getElementById("Rivals").value).split(',');
            addUserInRadarChart(you);
            for (let rival of rivals) {
                addUserInRadarChart(rival);
            }
            showRaderChart();
            //showBarGraph();
        }

        //テキストボックスに書かれたユーザーの情報をRadar Chart用に保持
        function addUserInRadarChart(name) {
            max_rating = 0;
            newSeries = {};
            newSeries.name = name;
            newSeries.axes = [];
            for (let tag in hash[name]) {
                if (hash[name][tag] == name) continue;
                if (max_rating < hash[name][tag].value) max_rating = hash[name][tag].value;
                newSeries.axes.push({ "axis": tag, "value": hash[name][tag].value });
            }
            data.push(newSeries);
        }

        //Radar Chartを表示
        function showRaderChart() {
            var margin = { top: 50, right: 80, bottom: 50, left: 80 };
            var radarChartOptions = {
                w: 300,
                h: 300,
                margin: margin,
                maxValue: max_rating,
                levels: 6,
                roundStrokes: true,
                color: d3.scaleOrdinal().range(["#26AF32", "#762712", "#2a2fd4"]),
                format: '.0f'
            };
            console.log(data);
            let svg_radar = RadarChart(".radarChart", data, radarChartOptions);
        }
    </script>
</body>

</html>