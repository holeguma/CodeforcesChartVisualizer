<!DOCTYPE html>
<html lang="en">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
    <link href="https://fonts.googleapis.com/css?family=Open+Sans:400,300" rel='stylesheet' type='text/css'>
    <link href='https://fonts.googleapis.com/css?family=Raleway' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="style.css">
    <title>D3 Test</title>
    <script src="https://d3js.org/d3.v5.min.js" charset="utf-8"></script>
    <script src="https://d3js.org/d3-path.v1.min.js" charset="utf-8"></script>
    <script src="./bower_components/radar-chart-d3/src/radar-chart.js" charset="utf-8"></script>
</head>

<body>
    <div class="tab_wrap">
        <input id="tab1" type="radio" name="tab_btn" checked>
        <input id="tab2" type="radio" name="tab_btn">
        <input id="tab3" type="radio" name="tab_btn">

        <div class="tab_area">
            <label class="tab1_label" for="tab1">Radar Chart</label>
            <label class="tab2_label" for="tab2">tab2</label>
            <label class="tab3_label" for="tab3">tab3</label>
        </div>
        <div class="panel_area">
            <div id="panel1" class="tab_panel">
                <div class="box_1">
                    <br><br>
                    <h1>&nbsp;&nbsp;User</h1>
                    <form id="form1" action="#" method="GET" class="cp_iptxt">
                        <input type="text" id="You" alue="" placeholder="You"><br>
                        <span class="sample1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VS<br></span>
                        <input type="text" id="Rivals" value="" placeholder="Rival(s)"><br><br>
                        <span class="sample1">Solved&nbsp;Problems&nbsp;>=&nbsp;&nbsp;</span>
                        <select name="form2" id="form2">
                            <option value="0">0</option>
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                            <option value="6">6</option>
                            <option value="7">7</option>
                            <option value="8">8</option>
                            <option value="9">9</option>
                            <option value="10">10</option>
                        </select>
                        <br><br>
                        <input type="button" name="Enter" onclick="enter_clicked()" value="Enter" />
                    </form>
                </div>


                <div class="box_2">
                    <div class="radarChart" style="display: inline-flex;"></div>
                </div>
                <div class="box_3">
                    <svg id="legend-div"></svg>
                </div>
            </div>
            <div id="panel2" class="tab_panel">
                <p>panel2</p>
            </div>
            <div id="panel3" class="tab_panel">
                <p>panel3</p>
            </div>
        </div>
    </div>




    <script type="text/javascript">
        //このファイルと同じディレクトリに「lib/d3.js」と「contest_data」(これはGoogle Driveで共有します)を置いてください

        var cnt = 0;
        let n_contests = 1260;
        var legendVals = []

        var hash = {};
        d3.json("./user_data/small_hash_data.json").then(function(data) {
            hash = JSON.parse(JSON.stringify(data));
            console.log(hash["Mojumbo"]);
            console.log(hash["holeguma"]);
            console.log(hash["tourist"]);
            console.log(hash["rng_58"]);
            console.log(hash["ransewhale"]);
            console.log(hash["QWE_QWE"]);
            console.log(hash["totori0908"]);
            console.log(hash["Rubikun"]);

        })

        function showBarGraph() {
            var svg = d3.select("body")
                .append("svg")
                .attr("width", 1200)
                .attr("height", 1000);
            svg.selectAll("rect")
                .data(data[0].axes)
                .enter()
                .append("rect")
                .attr("x", function(d, i) {
                    return i * (20 + 1);
                })
                .attr("y", function(d, i) {
                    return 500 - d.value / 10;
                })
                .attr("width", 20)
                .attr("height", function(d) {
                    return d.value / 10;
                });
            console.log("done");
        }

        function enter_clicked() {
            var minSolveCount = document.getElementById("form2").value;
            console.log(minSolveCount);
            data = [];
            legendVals = [];
            selected_tags = {};
            var you = document.getElementById("You").value;
            var rivals = (document.getElementById("Rivals").value).split(',');
            for (var tag in hash[you]["tags"]) {
                if (hash[you]["tags"][tag] == you) continue;
                if (hash[you]["tags"][tag].solveCount >= minSolveCount) {
                    //console.log(tag)
                    selected_tags[tag] = true;
                }
            }
            addUserInRadarChart(you);
            for (let rival of rivals) {
                addUserInRadarChart(rival);
            }
            d3.selectAll("g").remove();
            showLegend();
            showRaderChart();
        }

        //テキストボックスに書かれたユーザーの情報をRadar Chart用に保持
        function addUserInRadarChart(name) {
            max_rating = 0;
            newSeries = {};
            newSeries.name = name;
            newSeries.axes = [];
            for (let tag in hash[name]["tags"]) {
                if (hash[name]["tags"][tag] == name) continue;
                if (!selected_tags[tag]) continue;
                if (max_rating < hash[name]["tags"][tag].value) max_rating = hash[name]["tags"][tag].value;
                newSeries.axes.push({
                    "axis": tag,
                    "value": hash[name]["tags"][tag].value
                });
            }
            data.push(newSeries);
            legendVals.push(name);
        }

        //Radar Chartを表示
        function showRaderChart() {
            var margin = {
                top: 50,
                right: 80,
                bottom: 80,
                left: 80
            };
            var radarChartOptions = {
                w: 300,
                h: 300,
                margin: margin,
                maxValue: max_rating,
                opacityArea: 0.1,
                levels: 6,
                roundStrokes: false,
                color: d3.scaleOrdinal(d3.schemeCategory10),
                format: '.0f'
            };
            console.log(data);

            let svg_radar = RadarChart(".radarChart", data, radarChartOptions);
        }

        function showLegend() {
            let legend = d3.select("#legend-div")
                .attr("width", 100)
                .attr("height", 1000)
                .selectAll("g")
                .data(legendVals)
                .enter()
                .append("g")
                .attr("class", "legends");

            legend.append('rect')
                .attr("x", 0)
                .attr("y", 10)
                .attr("width", 10)
                .attr("height", 10)
                .style("fill", function(d, i) {
                    return d3.schemeCategory10[i];
                });

            legend.append('text')
                .attr("x", 20)
                .attr("y", 20)
                .text(function(d, i) {
                    return d;
                })
                .attr("class", "textselected")
                .style("text-anchor", "start")
                .style("font-size", 15);

            legend.attr("transform", function(d, i) {
                {
                    return "translate(0," + (i + 1) * 40 + ")";
                }
            });
        }
    </script>
</body>

</html>
